import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, getDoc, 
  onSnapshot, updateDoc, deleteDoc, addDoc, query, where 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from 'firebase/auth';
import { 
  Trophy, Settings, Lock, Unlock, Plus, Trash2, Edit2, 
  LogOut, Star, AlertCircle, Medal, BarChart3, 
  Calendar, Save, ShieldCheck, Target, Zap, ChevronRight,
  Users, Image as ImageIcon, UserPlus, Camera, User
} from 'lucide-react';

// --- CONFIGURAÇÃO FIREBASE DO USUÁRIO ---
const firebaseConfig = {
  apiKey: "AIzaSyA1R9T2koetMW6Gogo7NAzt8FVkfpdMpsU",
  authDomain: "bolaocomprasbrasileirao.firebaseapp.com",
  projectId: "bolaocomprasbrasileirao",
  storageBucket: "bolaocomprasbrasileirao.firebasestorage.app",
  messagingSenderId: "575686491581",
  appId: "1:575686491581:web:399d2ab692ee17a0bba6d4",
  measurementId: "G-F62PQLJC9Y"
};

// Inicialização do Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'bolaocomprasbrasileirao-prod';

// --- CONSTANTES ---
const ADMIN_PASSWORD = "admin123";

const INITIAL_PLAYERS = [
  "Jordan", "Carlos", "Ana", "Pedro", "Lucas", 
  "Mateus", "Rafael", "Bruno", "Tiago", "Fernanda"
];

const INITIAL_TEAMS = [
  { id: 'ath', name: 'Athletico Paranaense' }, { id: 'atm', name: 'Atlético Mineiro' },
  { id: 'bah', name: 'Bahia' }, { id: 'bot', name: 'Botafogo' },
  { id: 'cha', name: 'Chapecoense' }, { id: 'cor', name: 'Corinthians' },
  { id: 'crt', name: 'Coritiba' }, { id: 'cru', name: 'Cruzeiro' },
  { id: 'fla', name: 'Flamengo' }, { id: 'flu', name: 'Fluminense' },
  { id: 'gre', name: 'Grêmio' }, { id: 'int', name: 'Internacional' },
  { id: 'mir', name: 'Mirassol' }, { id: 'pal', name: 'Palmeiras' },
  { id: 'rbb', name: 'Red Bull Bragantino' }, { id: 'rem', name: 'Remo' },
  { id: 'san', name: 'Santos' }, { id: 'spa', name: 'São Paulo' },
  { id: 'vas', name: 'Vasco da Gama' }, { id: 'vit', name: 'Vitória' }
];

// Calendário completo atualizado para 38 rodadas
const CALENDAR = [
  { r: 1, d: '2026-02-01', games: [['flu','gre'],['bot','cru'],['spa','fla'],['cor','bah'],['mir','vas'],['atm','pal'],['int','ath'],['crt','rbb'],['vit','rem'],['cha','san']] },
  { r: 2, d: '2026-02-04', games: [['fla','int'],['vas','cha'],['san','spa'],['pal','vit'],['rbb','atm'],['cru','crt'],['gre','bot'],['ath','cor'],['bah','flu'],['rem','mir']] },
  { r: 3, d: '2026-02-11', games: [['flu','bot'],['vas','bah'],['spa','gre'],['cor','rbb'],['mir','cru'],['atm','rem'],['int','pal'],['ath','san'],['vit','fla'],['cha','crt']] },
  { r: 4, d: '2026-02-25', games: [['fla','mir'],['bot','vit'],['san','vas'],['pal','flu'],['rbb','ath'],['cru','cor'],['gre','atm'],['crt','spa'],['bah','cha'],['rem','int']] },
  { r: 5, d: '2026-03-11', games: [['fla','cru'],['vas','pal'],['spa','cha'],['cor','crt'],['mir','san'],['atm','int'],['gre','rbb'],['ath','bot'],['bah','vit'],['rem','flu']] },
  { r: 6, d: '2026-03-15', games: [['flu','ath'],['bot','fla'],['san','cor'],['pal','mir'],['rbb','spa'],['cru','vas'],['int','bah'],['crt','rem'],['vit','atm'],['cha','gre']] },
  { r: 7, d: '2026-03-18', games: [['fla','rem'],['vas','flu'],['san','int'],['pal','bot'],['mir','crt'],['atm','spa'],['gre','vit'],['ath','cru'],['bah','rbb'],['cha','cor']] },
  { r: 8, d: '2026-03-22', games: [['flu','atm'],['vas','gre'],['spa','pal'],['cor','fla'],['rbb','bot'],['cru','san'],['int','cha'],['ath','crt'],['vit','mir'],['rem','bah']] },
  { r: 9, d: '2026-04-01', games: [['flu','cor'],['bot','mir'],['san','rem'],['pal','gre'],['rbb','fla'],['cru','vit'],['int','spa'],['crt','vas'],['bah','ath'],['cha','atm']] },
  { r: 10, d: '2026-04-05', games: [['fla','san'],['vas','bot'],['spa','cru'],['cor','int'],['mir','rbb'],['atm','ath'],['gre','rem'],['crt','flu'],['bah','pal'],['cha','vit']] },
  { r: 11, d: '2026-04-12', games: [['flu','fla'],['bot','crt'],['san','atm'],['cor','pal'],['mir','bah'],['cru','rbb'],['int','gre'],['ath','cha'],['vit','spa'],['rem','vas']] },
  { r: 12, d: '2026-04-19', games: [['fla','bah'],['vas','spa'],['san','flu'],['pal','ath'],['rbb','rem'],['cru','gre'],['int','mir'],['crt','atm'],['vit','cor'],['cha','bot']] },
  { r: 13, d: '2026-04-25', games: [['flu','cha'],['bot','int'],['spa','mir'],['cor','vas'],['rbb','pal'],['atm','fla'],['gre','crt'],['ath','vit'],['bah','san'],['rem','cru']] },
  { r: 14, d: '2026-05-03', games: [['fla','vas'],['bot','rem'],['spa','bah'],['pal','san'],['mir','cor'],['cru','atm'],['int','flu'],['ath','gre'],['vit','crt'],['cha','rbb']] },
  { r: 15, d: '2026-05-10', games: [['flu','vit'],['vas','ath'],['san','rbb'],['cor','spa'],['mir','cha'],['atm','bot'],['gre','fla'],['crt','int'],['bah','cru'],['rem','pal']] },
  { r: 16, d: '2026-05-17', games: [['flu','spa'],['bot','cor'],['san','crt'],['pal','cru'],['rbb','vit'],['atm','mir'],['int','vas'],['ath','fla'],['bah','gre'],['cha','rem']] },
  { r: 17, d: '2026-05-24', games: [['fla','pal'],['vas','rbb'],['spa','bot'],['cor','atm'],['mir','flu'],['cru','cha'],['gre','san'],['crt','bah'],['vit','int'],['rem','ath']] },
  { r: 18, d: '2026-05-31', games: [['fla','crt'],['vas','atm'],['san','vit'],['pal','cha'],['rbb','int'],['cru','flu'],['gre','cor'],['ath','mir'],['bah','bot'],['rem','spa']] },
  { r: 19, d: '2026-07-22', games: [['flu','rbb'],['bot','san'],['spa','ath'],['cor','rem'],['mir','gre'],['atm','bah'],['int','cru'],['crt','pal'],['vit','vas'],['cha','fla']] },
  { r: 20, d: '2026-07-26', games: [['fla','spa'],['vas','mir'],['san','cha'],['pal','atm'],['rbb','crt'],['cru','bot'],['gre','flu'],['ath','int'],['bah','cor'],['rem','vit']] },
  { r: 21, d: '2026-07-29', games: [['flu','bah'],['bot','gre'],['spa','san'],['cor','ath'],['mir','rem'],['atm','rbb'],['int','fla'],['cru','crt'],['vit','pal'],['cha','vas']] },
  { r: 22, d: '2026-08-09', games: [['fla','vit'],['bot','flu'],['san','ath'],['pal','int'],['rbb','cor'],['cru','mir'],['gre','spa'],['crt','cha'],['bah','vas'],['rem','atm']] },
  { r: 23, d: '2026-08-16', games: [['flu','pal'],['vas','san'],['spa','crt'],['cor','cru'],['mir','fla'],['atm','gre'],['int','rem'],['ath','rbb'],['vit','bot'],['cha','bah']] },
  { r: 24, d: '2026-08-23', games: [['flu','rem'],['bot','ath'],['san','mir'],['pal','vas'],['rbb','gre'],['cru','fla'],['int','atm'],['crt','cor'],['vit','bah'],['cha','spa']] },
  { r: 25, d: '2026-08-30', games: [['fla','bot'],['vas','cru'],['spa','rbb'],['cor','san'],['mir','pal'],['atm','vit'],['gre','cha'],['ath','flu'],['bah','int'],['rem','crt']] },
  { r: 26, d: '2026-09-06', games: [['flu','vas'],['bot','pal'],['spa','atm'],['cor','cha'],['rbb','bah'],['cru','ath'],['int','san'],['crt','mir'],['vit','gre'],['rem','fla']] },
  { r: 27, d: '2026-09-13', games: [['fla','cor'],['bot','rbb'],['san','cru'],['pal','spa'],['mir','vit'],['atm','flu'],['gre','vas'],['ath','crt'],['bah','rem'],['cha','int']] },
  { r: 28, d: '2026-09-20', games: [['fla','rbb'],['vas','crt'],['spa','int'],['cor','flu'],['mir','bot'],['atm','cha'],['gre','pal'],['ath','bah'],['vit','cru'],['rem','san']] },
  { r: 29, d: '2026-10-07', games: [['flu','crt'],['bot','vas'],['san','fla'],['pal','bah'],['rbb','mir'],['cru','spa'],['int','cor'],['ath','atm'],['vit','cha'],['rem','gre']] },
  { r: 30, d: '2026-10-11', games: [['fla','flu'],['vas','rem'],['spa','vit'],['pal','cor'],['rbb','cru'],['atm','san'],['gre','int'],['crt','bot'],['bah','mir'],['cha','ath']] },
  { r: 31, d: '2026-10-18', games: [['flu','san'],['bot','cha'],['spa','vas'],['cor','vit'],['mir','int'],['atm','crt'],['gre','cru'],['ath','pal'],['bah','fla'],['rem','rbb']] },
  { r: 32, d: '2026-10-25', games: [['fla','atm'],['vas','cor'],['san','bah'],['pal','rbb'],['mir','spa'],['cru','rem'],['int','bot'],['crt','gre'],['vit','ath'],['cha','flu']] },
  { r: 33, d: '2026-10-28', games: [['flu','int'],['vas','fla'],['san','pal'],['cor','mir'],['rbb','cha'],['atm','cru'],['gre','ath'],['crt','vit'],['bah','spa']] },
  { r: 34, d: '2026-11-04', games: [['rem','bot'],['fla','gre'],['bot','atm'],['spa','cor'],['pal','rem'],['rbb','san'],['cru','bah'],['int','crt'],['ath','vas'],['vit','flu'],['cha','mir']] },
  { r: 35, d: '2026-11-18', games: [['fla','ath'],['vas','int'],['spa','flu'],['cor','bot'],['mir','atm'],['cru','pal'],['gre','bah'],['crt','san'],['vit','rbb'],['rem','cha']] },
  { r: 36, d: '2026-11-22', games: [['flu','mir'],['bot','spa'],['san','gre'],['pal','fla'],['rbb','vas'],['atm','cor'],['int','vit'],['ath','rem'],['bah','crt'],['cha','cru']] },
  { r: 37, d: '2026-11-29', games: [['flu','cru'],['bot','bah'],['spa','rem'],['cor','gre'],['mir','ath'],['atm','vas'],['int','rbb'],['crt','fla'],['vit','san'],['cha','pal']] },
  { r: 38, d: '2026-12-02', games: [['fla','cha'],['vas','vit'],['san','bot'],['pal','crt'],['rbb','flu'],['cru','int'],['gre','mir'],['ath','spa']] }
];

// --- COMPONENTE PRINCIPAL ---
export default function App() {
  const [user, setUser] = useState(null);
  const [selectedPlayer, setSelectedPlayer] = useState(null);
  const [view, setView] = useState('palpites');
  const [currentRound, setCurrentRound] = useState(3); // Inicia na Rodada 3 conforme pedido
  const [adminAuth, setAdminAuth] = useState(false);
  const [adminPassInput, setAdminPassInput] = useState("");
  const [adminTab, setAdminTab] = useState('rodadas');
  
  const [players, setPlayers] = useState([]);
  const [teams, setTeams] = useState([]);
  const [matches, setMatches] = useState([]);
  const [predictions, setPredictions] = useState([]);
  const [bonusData, setBonusData] = useState([]);
  const [config, setConfig] = useState({ rodada_fechada: false });
  const [loading, setLoading] = useState(true);

  // 1. Auth com Fallback
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          try {
            await signInWithCustomToken(auth, __initial_auth_token);
          } catch (tokenErr) {
            await signInAnonymously(auth);
          }
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Erro crítico de autenticação:", err);
      }
    };
    initAuth();
    const unsub = onAuthStateChanged(auth, setUser);
    return () => unsub();
  }, []);

  // 2. Sync Firestore
  useEffect(() => {
    if (!user) return;

    const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
    const unsubConfig = onSnapshot(configRef, (docSnap) => {
      if (docSnap.exists()) setConfig(docSnap.data());
      else checkInitialData();
    });

    const unsubPlayers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'players'), (snap) => {
      const pList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setPlayers(pList);
      if (selectedPlayer) {
        const updatedSelected = pList.find(p => p.id === selectedPlayer.id);
        if (updatedSelected) setSelectedPlayer(updatedSelected);
      }
    });

    const unsubTeams = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), (snap) => {
      setTeams(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    const unsubMatches = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), (snap) => {
      setMatches(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    const unsubPredictions = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'predictions'), (snap) => {
      setPredictions(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    const unsubBonus = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'bonus'), (snap) => {
      setBonusData(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      setLoading(false);
    });

    return () => {
      unsubConfig(); unsubPlayers(); unsubTeams(); unsubMatches(); unsubPredictions(); unsubBonus();
    };
  }, [user, selectedPlayer?.id]);

  const checkInitialData = async () => {
    if (!user) return;
    const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
    const snap = await getDoc(configRef);
    if (!snap.exists()) {
      await setDoc(configRef, { rodada_fechada: false });
      const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'players');
      for (const name of INITIAL_PLAYERS) {
        await addDoc(playersRef, { name, points: 0, bonusPoints: 0, totalPoints: 0, avatar: "" });
      }
      const teamsRef = collection(db, 'artifacts', appId, 'public', 'data', 'teams');
      for (const t of INITIAL_TEAMS) {
        await setDoc(doc(teamsRef, t.id), { name: t.name, logo: "" });
      }
      const matchesRef = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
      for (const rodada of CALENDAR) {
        for (const jogo of rodada.games) {
          await addDoc(matchesRef, { round: rodada.r, date: rodada.d, homeId: jogo[0], awayId: jogo[1] });
        }
      }
    }
  };

  const calculateScores = async () => {
    if (!user) return;
    for (const player of players) {
      let points = 0;
      matches.forEach(match => {
        if (match.homeScore !== undefined && match.awayScore !== undefined) {
          const pred = predictions.find(p => p.playerId === player.id && p.matchId === match.id);
          if (pred && pred.homeScore !== "" && pred.awayScore !== "") {
            const rH = parseInt(match.homeScore); const rA = parseInt(match.awayScore);
            const pH = parseInt(pred.homeScore); const pA = parseInt(pred.awayScore);

            if (rH === pH && rA === pA) points += 5;
            else if ((rH > rA && pH > pA) || (rH < rA && pH < pA) || (rH === rA && pH === pA)) points += 3;
            else points -= 1;
          }
        }
      });
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', player.id), {
        points: points,
        totalPoints: points + (player.bonusPoints || 0)
      });
    }
    alert("Ranking processado pela rede neural!");
  };

  // --- UI COMPONENTS ---

  const GlassCard = ({ children, className = "" }) => (
    <div className={`bg-zinc-900/60 backdrop-blur-xl border border-white/10 rounded-2xl p-4 shadow-2xl shadow-emerald-900/10 ${className}`}>
      {children}
    </div>
  );

  const Header = () => (
    <header className="sticky top-0 z-50 p-4 pb-0 bg-black/80 backdrop-blur-md border-b border-white/5">
      <div className="max-w-4xl mx-auto flex justify-between items-center mb-4">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-emerald-500 rounded-lg shadow-[0_0_15px_rgba(16,185,129,0.5)]">
            <Trophy className="text-black" size={24} />
          </div>
          <div>
            <h1 className="text-xl font-black text-white tracking-tighter uppercase italic leading-none">Cyber <span className="text-emerald-500">Bolão</span></h1>
            <p className="text-[9px] text-zinc-500 font-bold tracking-[0.2em] uppercase mt-1">Brasileirão Series A 2026</p>
          </div>
        </div>
        <button onClick={() => setView('admin')} className={`p-2 rounded-xl transition-colors ${view === 'admin' ? 'bg-emerald-500 text-black shadow-[0_0_10px_rgba(16,185,129,0.4)]' : 'bg-zinc-800 text-zinc-400 hover:text-emerald-400'}`}>
          <Settings size={20} />
        </button>
      </div>
      
      {view !== 'admin' && (
        <div className="max-w-4xl mx-auto mb-4 flex items-center gap-3">
          <div className="relative group">
             <div className="w-12 h-12 bg-black border-2 border-emerald-500/30 rounded-full flex items-center justify-center overflow-hidden shadow-[0_0_15px_rgba(16,185,129,0.15)] group-hover:border-emerald-500 transition-all">
               {selectedPlayer?.avatar ? (
                 <img src={selectedPlayer.avatar} alt="Avatar" className="w-full h-full object-cover" />
               ) : (
                 <User className="text-emerald-500/40" size={20} />
               )}
             </div>
             <div className="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 rounded-full border-2 border-black flex items-center justify-center">
                <Zap size={8} className="text-black fill-black" />
             </div>
          </div>
          
          <div className="flex-1">
            <label className="text-[9px] text-emerald-500/50 font-black uppercase mb-1 block ml-1 tracking-widest">Participante</label>
            <select 
              value={selectedPlayer?.id || ""} 
              onChange={(e) => setSelectedPlayer(players.find(x => x.id === e.target.value))}
              className="w-full bg-zinc-900 border border-white/10 text-white rounded-xl p-3 font-bold text-sm focus:border-emerald-500 outline-none appearance-none cursor-pointer shadow-inner"
            >
              <option value="">AUTENTICAR NO TERMINAL...</option>
              {players.map(p => <option key={p.id} value={p.id}>{String(p.name || "").toUpperCase()}</option>)}
            </select>
          </div>
        </div>
      )}
    </header>
  );

  const Navigation = () => (
    <nav className="fixed bottom-0 left-0 right-0 bg-black/95 backdrop-blur-2xl border-t border-white/5 p-4 z-50 flex justify-around items-center max-w-4xl mx-auto md:rounded-t-[40px] shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
      {[
        { id: 'palpites', icon: Zap, label: 'Arena' },
        { id: 'bonus', icon: Target, label: 'Bônus' },
        { id: 'ranking', icon: BarChart3, label: 'Ranking' }
      ].map(item => (
        <button 
          key={item.id}
          onClick={() => setView(item.id)} 
          className={`flex flex-col items-center transition-all duration-300 ${view === item.id ? 'text-emerald-400 scale-110' : 'text-zinc-600 hover:text-zinc-400'}`}
        >
          <div className={`p-1 rounded-lg transition-all ${view === item.id ? 'bg-emerald-500/10' : ''}`}>
             <item.icon size={24} className={view === item.id ? 'drop-shadow-[0_0_8px_rgba(52,211,153,0.8)]' : ''} />
          </div>
          <span className="text-[9px] font-black mt-1 uppercase tracking-tighter">{item.label}</span>
        </button>
      ))}
    </nav>
  );

  const PalpitesView = () => {
    const handleSave = async (matchId, h, a) => {
      if (!selectedPlayer || !user) return;
      const predId = `${selectedPlayer.id}_${matchId}`;
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'predictions', predId), {
        playerId: selectedPlayer.id, matchId, homeScore: h, awayScore: a
      });
    };

    const filtered = matches.filter(m => m.round === currentRound);

    return (
      <div className="p-4 pb-32 max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-4">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-2">
            <Calendar className="text-emerald-500" size={18} />
            <span className="text-lg font-black text-white uppercase italic tracking-tighter">Arena Rodada {currentRound}</span>
          </div>
          <select 
            value={currentRound} 
            onChange={e => setCurrentRound(parseInt(e.target.value))}
            className="bg-zinc-900 border border-white/10 text-white rounded-lg px-3 py-1 text-xs font-black outline-none hover:border-emerald-500/50 transition-colors"
          >
            {[...Array(38)].map((_, i) => <option key={i+1} value={i+1}>R{i+1}</option>)}
          </select>
        </div>

        {config.rodada_fechada && (
          <GlassCard className="mb-6 border-red-500/40 bg-red-950/20 flex items-center gap-4 py-4">
            <div className="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center shadow-[0_0_15px_rgba(239,68,68,0.4)]">
               <Lock className="text-black" size={20} />
            </div>
            <div>
               <p className="text-red-500 text-xs font-black uppercase tracking-widest">Coleta Bloqueada</p>
               <p className="text-red-500/60 text-[10px] uppercase font-bold">Protocolo encerrado pela central</p>
            </div>
          </GlassCard>
        )}

        <div className="space-y-4">
          {filtered.map(match => {
            const pred = predictions.find(p => p.playerId === selectedPlayer?.id && p.matchId === match.id);
            const hT = teams.find(t => t.id === match.homeId);
            const aT = teams.find(t => t.id === match.awayId);
            return (
              <GlassCard key={match.id} className="relative overflow-hidden group">
                <div className="absolute top-0 left-0 w-1 h-full bg-emerald-500/30 group-hover:bg-emerald-500 transition-all" />
                <div className="flex items-center justify-between">
                  {/* Mandante */}
                  <div className="flex-1 flex flex-col items-center">
                    <div className="w-12 h-12 bg-black/60 rounded-xl flex items-center justify-center mb-2 border border-white/5 overflow-hidden shadow-inner group-hover:border-emerald-500/30 transition-all">
                      {hT?.logo ? (
                        <img src={hT.logo} alt={hT.name} className="w-9 h-9 object-contain" />
                      ) : (
                        <ShieldCheck className="text-zinc-700" size={20} />
                      )}
                    </div>
                    <span className="text-[10px] font-black text-white uppercase text-center leading-tight max-w-[80px]">{hT?.name}</span>
                  </div>
                  
                  {/* Placar */}
                  <div className="flex items-center gap-3 px-4">
                    <input 
                      type="number" 
                      disabled={config.rodada_fechada || !selectedPlayer} 
                      value={pred?.homeScore ?? ""} 
                      onChange={e => handleSave(match.id, e.target.value, pred?.awayScore || "")} 
                      className="w-12 h-16 text-center bg-black border border-white/10 rounded-2xl font-black text-2xl text-emerald-400 focus:border-emerald-500 outline-none disabled:opacity-30 transition-all shadow-[inset_0_2px_10px_rgba(0,0,0,0.5)]" 
                    />
                    <div className="flex flex-col items-center">
                       <span className="text-emerald-500/20 font-black italic text-xs">VS</span>
                       <div className="w-px h-4 bg-white/5 my-1" />
                    </div>
                    <input 
                      type="number" 
                      disabled={config.rodada_fechada || !selectedPlayer} 
                      value={pred?.awayScore ?? ""} 
                      onChange={e => handleSave(match.id, pred?.homeScore || "", e.target.value)} 
                      className="w-12 h-16 text-center bg-black border border-white/10 rounded-2xl font-black text-2xl text-emerald-400 focus:border-emerald-500 outline-none disabled:opacity-30 transition-all shadow-[inset_0_2px_10px_rgba(0,0,0,0.5)]" 
                    />
                  </div>

                  {/* Visitante */}
                  <div className="flex-1 flex flex-col items-center">
                    <div className="w-12 h-12 bg-black/60 rounded-xl flex items-center justify-center mb-2 border border-white/5 overflow-hidden shadow-inner group-hover:border-emerald-500/30 transition-all">
                      {aT?.logo ? (
                        <img src={aT.logo} alt={aT.name} className="w-9 h-9 object-contain" />
                      ) : (
                        <ShieldCheck className="text-zinc-700" size={20} />
                      )}
                    </div>
                    <span className="text-[10px] font-black text-white uppercase text-center leading-tight max-w-[80px]">{aT?.name}</span>
                  </div>
                </div>
                {match.homeScore !== undefined && (
                  <div className="mt-4 pt-3 border-t border-white/5 flex items-center justify-center gap-3">
                    <Target size={12} className="text-emerald-500" />
                    <span className="text-[10px] font-black text-emerald-500 uppercase tracking-widest italic">Oficial: {match.homeScore} x {match.awayScore}</span>
                  </div>
                )}
              </GlassCard>
            );
          })}
        </div>
      </div>
    );
  };

  const BonusView = () => {
    const [selections, setSelections] = useState({
      g4: [], z4: [], g8: [], campeao: "", artilheiro: ""
    });

    const playerBonus = bonusData.find(b => b.playerId === selectedPlayer?.id);

    const handleSaveBonus = async () => {
      if (!selectedPlayer || !user) return alert("Erro: Bio-ID não autenticado.");
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bonus', selectedPlayer.id), {
        playerId: selectedPlayer.id,
        ...selections
      });
      alert("Projeções arquivadas!");
    };

    const toggleTeam = (list, teamId, max) => {
      const newList = selections[list].includes(teamId) 
        ? selections[list].filter(id => id !== teamId)
        : selections[list].length < max ? [...selections[list], teamId] : selections[list];
      setSelections({...selections, [list]: newList});
    };

    useEffect(() => {
      if (playerBonus) setSelections(playerBonus);
    }, [playerBonus]);

    return (
      <div className="p-4 pb-32 max-w-4xl mx-auto">
        <h2 className="text-xl font-black text-white uppercase italic mb-6">Módulo <span className="text-emerald-500">Projeção</span></h2>
        <GlassCard className="mb-6 space-y-8">
          <div>
            <div className="flex items-center gap-2 mb-4">
               <div className="w-1 h-4 bg-emerald-500" />
               <label className="text-xs font-black text-white uppercase tracking-wider">Quadrante G4 (Elite)</label>
            </div>
            <div className="flex flex-wrap gap-2">
              {teams.sort((a,b) => a.name.localeCompare(b.name)).map(t => (
                <button 
                  key={t.id} 
                  onClick={() => toggleTeam('g4', t.id, 4)}
                  className={`px-3 py-2 rounded-xl text-[10px] font-bold border transition-all ${selections.g4.includes(t.id) ? 'bg-emerald-500 border-emerald-400 text-black shadow-[0_0_15px_rgba(16,185,129,0.4)]' : 'bg-zinc-800 border-white/5 text-zinc-500'}`}
                >
                  {t.name}
                </button>
              ))}
            </div>
          </div>
          <div>
             <div className="flex items-center gap-2 mb-4">
               <div className="w-1 h-4 bg-red-500" />
               <label className="text-xs font-black text-white uppercase tracking-wider">Quadrante Z4 (Rebaixamento)</label>
            </div>
            <div className="flex flex-wrap gap-2">
              {teams.sort((a,b) => a.name.localeCompare(b.name)).map(t => (
                <button 
                  key={t.id} 
                  onClick={() => toggleTeam('z4', t.id, 4)}
                  className={`px-3 py-2 rounded-xl text-[10px] font-bold border transition-all ${selections.z4.includes(t.id) ? 'bg-red-500 border-red-400 text-black shadow-[0_0_15px_rgba(239,68,68,0.4)]' : 'bg-zinc-800 border-white/5 text-zinc-500'}`}
                >
                  {t.name}
                </button>
              ))}
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <GlassCard className="bg-black/40 border-white/5">
              <label className="text-[10px] font-black text-emerald-500 uppercase block mb-3">Futuro Campeão</label>
              <select 
                value={selections.campeao} 
                onChange={e => setSelections({...selections, campeao: e.target.value})}
                className="w-full bg-zinc-900 border border-white/10 rounded-xl p-3 text-xs text-white font-bold outline-none focus:border-emerald-500"
              >
                <option value="">SELECIONAR...</option>
                {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
              </select>
            </GlassCard>
            <GlassCard className="bg-black/40 border-white/5">
              <label className="text-[10px] font-black text-emerald-500 uppercase block mb-3">Bio-Artilheiro</label>
              <input 
                type="text" 
                placeholder="NOME DO JOGADOR" 
                value={selections.artilheiro}
                onChange={e => setSelections({...selections, artilheiro: e.target.value})}
                className="w-full bg-zinc-900 border border-white/10 rounded-xl p-3 text-xs text-white font-bold outline-none placeholder:text-zinc-700 focus:border-emerald-500" 
              />
            </GlassCard>
          </div>
          <button onClick={handleSaveBonus} className="w-full bg-emerald-500 text-black py-5 rounded-2xl font-black uppercase italic shadow-[0_10px_20px_rgba(16,185,129,0.3)] hover:scale-[1.01] active:scale-95 transition-all">
            Arquivar Projeções
          </button>
        </GlassCard>
      </div>
    );
  };

  const RankingView = () => {
    const sorted = [...players].sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
    return (
      <div className="p-4 pb-32 max-w-4xl mx-auto">
        <h2 className="text-xl font-black text-white uppercase italic mb-6">Painel de <span className="text-emerald-500">Status</span></h2>
        <GlassCard className="overflow-hidden p-0 border-white/5 shadow-emerald-900/5">
          <table className="w-full text-left">
            <thead className="bg-white/5 text-[9px] font-black text-emerald-500/50 uppercase tracking-[0.2em] border-b border-white/5">
              <tr>
                <th className="p-5">#</th>
                <th className="p-5">Bio-ID</th>
                <th className="p-5 text-center">Rodada</th>
                <th className="p-5 text-right">Total</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {sorted.map((p, idx) => (
                <tr key={p.id} className={`${selectedPlayer?.id === p.id ? 'bg-emerald-500/5' : ''} hover:bg-white/5 transition-colors`}>
                  <td className="p-5">
                    <span className={`text-xl font-black italic ${idx === 0 ? 'text-yellow-400 drop-shadow-[0_0_10px_rgba(250,204,21,0.6)]' : idx === 1 ? 'text-zinc-300' : idx === 2 ? 'text-orange-500' : 'text-zinc-700'}`}>
                      {String(idx + 1).padStart(2, '0')}
                    </span>
                  </td>
                  <td className="p-5">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center border border-emerald-500/20 overflow-hidden shadow-lg">
                        {p.avatar ? (
                          <img src={p.avatar} alt="P" className="w-full h-full object-cover" />
                        ) : (
                          <User size={18} className="text-emerald-500/30" />
                        )}
                      </div>
                      <span className="text-sm font-black text-white uppercase tracking-tighter">{String(p.name || "")}</span>
                    </div>
                  </td>
                  <td className="p-5 text-center">
                    <span className="text-xs font-bold text-zinc-500">{p.points || 0}</span>
                  </td>
                  <td className="p-5 text-right">
                    <div className="inline-block px-3 py-1 bg-emerald-500/10 rounded-lg">
                       <span className="text-lg font-black text-emerald-400">{p.totalPoints || 0}</span>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </GlassCard>
      </div>
    );
  };

  const AdminView = () => {
    const [newPlayerName, setNewPlayerName] = useState("");

    if (!adminAuth) return (
      <div className="flex flex-col items-center justify-center p-12 h-[calc(100vh-80px)] max-w-md mx-auto">
        <GlassCard className="w-full text-center border-emerald-500/20 bg-black/80">
          <div className="w-16 h-16 bg-emerald-500/10 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-[0_0_20px_rgba(16,185,129,0.1)]">
             <Lock className="text-emerald-500" size={32} />
          </div>
          <h2 className="text-xl font-black text-white uppercase mb-8 italic tracking-tighter">Terminal <span className="text-emerald-500">Adm</span></h2>
          <input 
            type="password" 
            placeholder="CÓDIGO DE ACESSO" 
            className="w-full bg-zinc-900 border border-white/10 p-5 rounded-2xl mb-6 text-center font-black text-white outline-none focus:border-emerald-500 transition-all placeholder:text-zinc-700" 
            value={adminPassInput} 
            onChange={e => setAdminPassInput(e.target.value)} 
          />
          <button 
            onClick={() => adminPassInput === ADMIN_PASSWORD ? setAdminAuth(true) : alert("Código Inválido")} 
            className="w-full bg-emerald-500 text-black py-5 rounded-2xl font-black uppercase italic tracking-widest shadow-[0_10px_20px_rgba(16,185,129,0.3)] active:scale-95 transition-all"
          >
            Acessar Bio-Núcleo
          </button>
        </GlassCard>
      </div>
    );

    const handleAddPlayer = async () => {
      if (!newPlayerName || !user) return;
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'players'), {
        name: newPlayerName, points: 0, bonusPoints: 0, totalPoints: 0, avatar: ""
      });
      setNewPlayerName("");
    };

    const handleUpdateField = async (id, field, value) => {
       if (!user) return;
       await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', id), {
         [field]: value
       });
    };

    return (
      <div className="p-4 pb-32 max-w-4xl mx-auto space-y-6">
        <div className="flex justify-between items-center mb-2">
          <h2 className="text-xl font-black uppercase italic tracking-tighter">Terminal <span className="text-emerald-500">Master</span></h2>
          <button onClick={() => setAdminAuth(false)} className="text-red-500 font-black flex items-center gap-2 text-[10px] uppercase tracking-tighter hover:bg-red-500/10 p-2 rounded-lg transition-all"><LogOut size={16}/> Sair</button>
        </div>

        <div className="flex bg-zinc-900/80 p-1.5 rounded-2xl border border-white/5 gap-1 shadow-inner">
          {['rodadas', 'jogadores', 'clubes'].map(tab => (
            <button 
              key={tab}
              onClick={() => setAdminTab(tab)}
              className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all tracking-wider ${adminTab === tab ? 'bg-emerald-500 text-black shadow-lg' : 'text-zinc-500 hover:text-white'}`}
            >
              {tab}
            </button>
          ))}
        </div>

        {adminTab === 'rodadas' && (
          <div className="space-y-6 animate-in fade-in zoom-in-95">
            <GlassCard className="flex items-center justify-between border-emerald-500/20">
              <div className="flex items-center gap-4">
                 <div className={`w-3 h-3 rounded-full ${config.rodada_fechada ? 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]' : 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]'}`} />
                 <div>
                    <p className="font-black uppercase text-[10px] text-zinc-500">Estado de Operação</p>
                    <span className={`text-lg font-black ${config.rodada_fechada ? 'text-red-500' : 'text-emerald-500'}`}>
                      {config.rodada_fechada ? 'SISTEMA TRAVADO' : 'COLETA ATIVA'}
                    </span>
                 </div>
              </div>
              <button 
                onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), { rodada_fechada: !config.rodada_fechada })}
                className={`px-6 py-2 rounded-xl font-black text-[10px] uppercase border transition-all ${config.rodada_fechada ? 'border-emerald-500 text-emerald-500 hover:bg-emerald-500/10' : 'border-red-500 text-red-500 hover:bg-red-500/10'}`}
              >
                {config.rodada_fechada ? 'Liberar Arena' : 'Travar Palpites'}
              </button>
            </GlassCard>

            <button onClick={calculateScores} className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-[0_0_25px_rgba(37,99,235,0.4)] hover:brightness-110 active:scale-95 transition-all">
              CALCULAR REDE NEURAL (PONTOS)
            </button>

            <div className="space-y-3">
              <div className="flex items-center justify-between px-1">
                <p className="font-black text-[10px] text-zinc-600 uppercase tracking-[0.3em]">Lançar Resultados - R{currentRound}</p>
                <select value={currentRound} onChange={e => setCurrentRound(parseInt(e.target.value))} className="bg-zinc-900 border border-white/10 text-emerald-500 text-[10px] font-black rounded-lg px-3 py-1.5 outline-none">
                  {[...Array(38)].map((_,i) => <option key={i+1} value={i+1}>R{i+1}</option>)}
                </select>
              </div>
              {matches.filter(m => m.round === currentRound).map(m => (
                <GlassCard key={m.id} className="flex items-center gap-2 py-3 bg-black/30">
                  <span className="text-[10px] font-bold text-zinc-400 w-24 text-right truncate uppercase italic">{teams.find(t=>t.id===m.homeId)?.name}</span>
                  <div className="flex items-center gap-1">
                    <input type="number" defaultValue={m.homeScore} onBlur={e => user && updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id), {homeScore: e.target.value})} className="w-10 bg-black border border-white/10 text-center font-black rounded-lg text-emerald-500 text-sm py-1.5 outline-none focus:border-emerald-500" />
                    <span className="text-zinc-800 font-bold px-1">X</span>
                    <input type="number" defaultValue={m.awayScore} onBlur={e => user && updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id), {awayScore: e.target.value})} className="w-10 bg-black border border-white/10 text-center font-black rounded-lg text-emerald-500 text-sm py-1.5 outline-none focus:border-emerald-500" />
                  </div>
                  <span className="text-[10px] font-bold text-zinc-400 flex-1 truncate uppercase italic">{teams.find(t=>t.id===m.awayId)?.name}</span>
                </GlassCard>
              ))}
            </div>
          </div>
        )}

        {adminTab === 'jogadores' && (
          <div className="space-y-4 animate-in fade-in slide-in-from-left-4">
            <GlassCard className="border-emerald-500/10">
              <div className="flex items-center gap-2 mb-4">
                 <UserPlus size={16} className="text-emerald-500" />
                 <p className="font-black text-[10px] text-emerald-500 uppercase tracking-widest">Nova Assinatura Bio</p>
              </div>
              <div className="flex gap-2">
                <input 
                  type="text" 
                  placeholder="NOME DO JOGADOR" 
                  value={newPlayerName}
                  onChange={e => setNewPlayerName(e.target.value)}
                  className="flex-1 bg-black border border-white/10 rounded-xl px-4 text-xs font-black text-white outline-none focus:border-emerald-500 transition-all uppercase"
                />
                <button onClick={handleAddPlayer} className="bg-emerald-500 text-black px-6 rounded-xl font-black uppercase text-[10px] shadow-lg">
                  REGISTRAR
                </button>
              </div>
            </GlassCard>

            <div className="space-y-4">
              <p className="font-black text-[10px] text-zinc-600 uppercase px-2 tracking-widest">Bio-IDs Conectados</p>
              {players.sort((a,b) => a.name.localeCompare(b.name)).map(p => (
                <GlassCard key={p.id} className="p-5 flex flex-col gap-4">
                  <div className="flex items-center justify-between">
                     <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-black border-2 border-white/5 overflow-hidden shadow-lg">
                           {p.avatar ? <img src={p.avatar} className="w-full h-full object-cover" /> : <User className="text-zinc-800 p-2" />}
                        </div>
                        <span className="text-sm font-black text-white uppercase italic">{p.name}</span>
                     </div>
                     <button onClick={() => user && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', p.id))} className="p-2 text-red-500/30 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all">
                       <Trash2 size={16} />
                     </button>
                  </div>
                  <div className="grid grid-cols-1 gap-3 pt-3 border-t border-white/5">
                     <div className="flex items-center gap-2">
                        <Camera size={14} className="text-emerald-500" />
                        <input 
                           type="text" 
                           placeholder="URL DA FOTO/AVATAR" 
                           defaultValue={p.avatar || ""}
                           onBlur={e => handleUpdateField(p.id, 'avatar', e.target.value)}
                           className="flex-1 bg-black border border-white/10 rounded-lg p-3 text-[10px] text-emerald-400 font-bold outline-none focus:border-emerald-500 transition-all"
                        />
                     </div>
                  </div>
                </GlassCard>
              ))}
            </div>
          </div>
        )}

        {adminTab === 'clubes' && (
          <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
            <p className="font-black text-[10px] text-zinc-600 uppercase px-1 tracking-widest italic">Protocolo de Imagem de Clubes</p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {teams.sort((a,b) => (a.name || "").localeCompare(b.name || "")).map(t => (
                <GlassCard key={t.id} className="flex flex-col gap-3 hover:border-emerald-500/20 transition-all">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-black rounded-lg flex items-center justify-center border border-white/5 shadow-inner">
                      {t.logo ? <img src={t.logo} className="w-7 h-7 object-contain" /> : <ImageIcon size={14} className="text-zinc-800" />}
                    </div>
                    <span className="text-[10px] font-black text-white uppercase truncate italic">{t.name}</span>
                  </div>
                  <input 
                    type="text" 
                    placeholder="URL DO ESCUDO" 
                    defaultValue={t.logo || ""}
                    onBlur={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', t.id), { logo: e.target.value })}
                    className="w-full bg-black border border-white/10 rounded-xl p-3 text-[10px] text-emerald-400 font-bold outline-none focus:border-emerald-500"
                  />
                </GlassCard>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  if (loading) return (
    <div className="h-screen bg-black flex flex-col items-center justify-center">
      <div className="w-16 h-16 border-[4px] border-emerald-500/10 border-t-emerald-500 rounded-full animate-spin mb-4 shadow-[0_0_20px_rgba(16,185,129,0.2)]" />
      <p className="text-emerald-500 font-black tracking-[0.4em] text-[10px] animate-pulse uppercase">Acessando Rodada 3...</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-black text-zinc-200 selection:bg-emerald-500 selection:text-black font-sans antialiased">
      {/* Background Decor */}
      <div className="fixed inset-0 pointer-events-none opacity-20 overflow-hidden">
        <div className="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] bg-emerald-600 blur-[150px] rounded-full animate-pulse" />
        <div className="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-blue-700 blur-[150px] rounded-full opacity-50" />
      </div>

      <Header />
      <main className="relative z-10">
        {view === 'palpites' && <PalpitesView />}
        {view === 'bonus' && <BonusView />}
        {view === 'ranking' && <RankingView />}
        {view === 'admin' && <AdminView />}
      </main>
      <Navigation />
    </div>
  );
}

